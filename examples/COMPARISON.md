# –°–≤–æ–¥–∫–∞: –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∏ –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã

## ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–´–ï –ø—Ä–∏–º–µ—Ä—ã (–∏—Å–ø–æ–ª—å–∑—É—é—Ç sample)

### 1. priority-example-1.js - –ë–∞–∑–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç:**
- `on()` –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–æ—Ä–∞
- `sample()` –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö –≤ —ç—Ñ—Ñ–µ–∫—Ç—ã

```bash
node examples/priority-example-1.js
```

---

### 2. priority-example-2.js - –°—Ç–æ—Ä + –≠—Ñ—Ñ–µ–∫—Ç
**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç:**
- `sample()` –¥–ª—è —Å–≤—è–∑—ã–≤–∞–Ω–∏—è —Å—Ç–æ—Ä–∞ —Å —ç—Ñ—Ñ–µ–∫—Ç–æ–º
- –°–æ–±—ã—Ç–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è

```bash
node examples/priority-example-2.js
```

---

### 3. priority-example-3-complex.js - –í—Å–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã
**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç:**
- `combine()` –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- `sample()` –¥–ª—è –≤—ã–±–æ—Ä–∫–∏ –¥–∞–Ω–Ω—ã—Ö

```bash
node examples/priority-example-3-complex.js
```

---

### 4. ‚úÖ priority-example-7-correct-sample.js - **–ö–û–†–†–ï–ö–¢–ù–û–ï** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç:**
- ‚úÖ `sample()` –ø–µ—Ä–µ–¥–∞–µ—Ç —Å–Ω–∏–º–æ–∫ –±–∞–ª–∞–Ω—Å–∞ –≤ —ç—Ñ—Ñ–µ–∫—Ç
- ‚úÖ –°–æ–±—ã—Ç–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–æ—Ä–∞ (`deductBalance`)
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í—Ç–æ—Ä–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞, –±–∞–ª–∞–Ω—Å = **400‚ÇΩ** ‚úÖ

```bash
node examples/priority-example-7-correct-sample.js
```

**–ö–ª—é—á–µ–≤–æ–π –∫–æ–¥:**
```javascript
const transferFx = createEffect(async ({amount, balance}) => {
  // balance - —Å–Ω–∏–º–æ–∫, –Ω–µ –∏–∑–º–µ–Ω–∏—Ç—Å—è
  if (balance >= amount) {
    deductBalance(amount) // –°–æ–±—ã—Ç–∏–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  }
})

sample({
  source: $balance,
  clock: transfer,
  target: transferFx
})
```

---

## ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–´–ï –ø—Ä–∏–º–µ—Ä—ã (–∏—Å–ø–æ–ª—å–∑—É—é—Ç getState)

### 5. priority-example-4-getState-vs-sample.js - –°—Ä–∞–≤–Ω–µ–Ω–∏–µ
**–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –û–ë–ê –ø–æ–¥—Ö–æ–¥–∞:**
- ‚ùå getState() –≤–Ω—É—Ç—Ä–∏ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
- ‚úÖ sample() –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö

**–¶–µ–ª—å:** –°—Ä–∞–≤–Ω–∏—Ç—å –æ–±–∞ –ø–æ–¥—Ö–æ–¥–∞ –∏ –ø–æ–∫–∞–∑–∞—Ç—å —Ä–∞–∑–Ω–∏—Ü—É

```bash
node examples/priority-example-4-getState-vs-sample.js
```

---

### 6. ‚ùå priority-example-6-incorrect-getState.js - **–ù–ï–ö–û–†–†–ï–ö–¢–ù–û–ï** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç:**
- ‚ùå `getState()` –¥–ª—è —á—Ç–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –≤ —ç—Ñ—Ñ–µ–∫—Ç–µ
- ‚ùå –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ getState()
- –°–æ–±—ã—Ç–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–ø—É–±–ª–∏—á–Ω—ã–π API)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ë–∞–ª–∞–Ω—Å —É—Ö–æ–¥–∏—Ç –≤ **–º–∏–Ω—É—Å -200‚ÇΩ** üí•

```bash
node examples/priority-example-6-incorrect-getState.js
```

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥:**
```javascript
const transferFx = createEffect(async ({amount, to}) => {
  const balance = $balance.getState() // ‚ùå –ß–∏—Ç–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ

  if (balance >= amount) {
    await delay()
    deductBalance(amount) // –ö —ç—Ç–æ–º—É –º–æ–º–µ–Ω—Ç—É –±–∞–ª–∞–Ω—Å –º–æ–≥ –∏–∑–º–µ–Ω–∏—Ç—å—Å—è!
  }
})
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –î–≤–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ 600‚ÇΩ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
2. –û–±–µ —á–∏—Ç–∞—é—Ç –±–∞–ª–∞–Ω—Å 1000‚ÇΩ —á–µ—Ä–µ–∑ `getState()`
3. –û–±–µ –ø—Ä–æ—Ö–æ–¥—è—Ç –ø—Ä–æ–≤–µ—Ä–∫—É `balance >= amount`
4. –û–±–µ —Å–ø–∏—Å—ã–≤–∞—é—Ç 600‚ÇΩ
5. **–†–µ–∑—É–ª—å—Ç–∞—Ç: 1000 - 600 - 600 = -200‚ÇΩ üí•**

---

## üéØ –ì–ª–∞–≤–Ω–∞—è —Ä–∞–∑–Ω–∏—Ü–∞

| | getState() | sample() |
|---|------------|----------|
| **–ö–æ–≥–¥–∞ —á–∏—Ç–∞–µ—Ç—Å—è** | –í –º–æ–º–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∞ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 5) | –í –º–æ–º–µ–Ω—Ç —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 4) |
| **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** | ‚ùå –ú–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å—Å—è –≤–æ –≤—Ä–µ–º—è async | ‚úÖ –°–Ω–∏–º–æ–∫ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è |
| **Race conditions** | ‚ùå –ù–µ –∑–∞—â–∏—â–∞–µ—Ç | ‚úÖ –ö–∞–∂–¥–æ–µ —Å–æ–±—ã—Ç–∏–µ –ø–æ–ª—É—á–∞–µ—Ç —Å–≤–æ–π —Å–Ω–∏–º–æ–∫ |
| **–†–µ–∑—É–ª—å—Ç–∞—Ç –≤ –ø—Ä–∏–º–µ—Ä–µ** | –ë–∞–ª–∞–Ω—Å **-200‚ÇΩ** üí• | –ë–∞–ª–∞–Ω—Å **400‚ÇΩ** ‚úÖ |

---

## üìä –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–±–ª–µ–º—ã

### ‚ùå –° getState():

```
t=0: balance = 1000‚ÇΩ

t=1: transfer(600) –∑–∞–ø—É—â–µ–Ω
     transfer(600) –∑–∞–ø—É—â–µ–Ω

t=2: –û–±–∞ —ç—Ñ—Ñ–µ–∫—Ç–∞ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è:
     fx1: balance = getState() ‚Üí 1000‚ÇΩ ‚úÖ
     fx2: balance = getState() ‚Üí 1000‚ÇΩ ‚úÖ

t=3: –û–±–∞ –ø—Ä–æ—à–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫—É

t=4: deductBalance(600) ‚Üí balance = 400‚ÇΩ
     deductBalance(600) ‚Üí balance = -200‚ÇΩ üí•
```

### ‚úÖ –° sample():

```
t=0: balance = 1000‚ÇΩ

t=1: transfer(600) ‚Üí sample –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç 1000‚ÇΩ –¥–ª—è fx1
     –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: balance = 400‚ÇΩ
     transfer(600) ‚Üí sample –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç 400‚ÇΩ –¥–ª—è fx2

t=2: fx1: balance = 1000‚ÇΩ ‚úÖ –ø—Ä–æ–≤–µ—Ä–∫–∞ OK
     fx2: balance = 400‚ÇΩ ‚ùå –ø—Ä–æ–≤–µ—Ä–∫–∞ FAILED

t=3: fx1: deductBalance(600) ‚Üí balance = 400‚ÇΩ ‚úÖ
     fx2: –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞
```

---

## üîë –ü—Ä–∞–≤–∏–ª–æ

```
–ï—Å–ª–∏ —ç—Ñ—Ñ–µ–∫—Ç –ü–†–ò–ù–ò–ú–ê–ï–¢ –†–ï–®–ï–ù–ò–Ø –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è:
  ‚ùå –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ getState()
  ‚úÖ –ò–°–ü–û–õ–¨–ó–£–ô–¢–ï sample()
```

---

## üìö –í—Å–µ –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –ø—É–±–ª–∏—á–Ω—ã–π API

–í—Å–µ –ø—Ä–∏–º–µ—Ä—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã –∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç **–¢–û–õ–¨–ö–û –ø—É–±–ª–∏—á–Ω—ã–π API Effector**:
- ‚úÖ `on()` –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–æ—Ä–æ–≤
- ‚úÖ –°–æ–±—ã—Ç–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
- ‚úÖ `sample()` –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö
- ‚ùå **–ù–ï–¢** `setState()` (–Ω–µ –ø—É–±–ª–∏—á–Ω—ã–π API)

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç

```bash
# –£–≤–∏–¥–µ—Ç—å –ø—Ä–æ–±–ª–µ–º—É —Å getState (–±–∞–ª–∞–Ω—Å -200‚ÇΩ)
node examples/priority-example-6-incorrect-getState.js

# –£–≤–∏–¥–µ—Ç—å —Ä–µ—à–µ–Ω–∏–µ —Å sample (–±–∞–ª–∞–Ω—Å 400‚ÇΩ)
node examples/priority-example-7-correct-sample.js
```
